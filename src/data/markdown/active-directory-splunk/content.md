# Mini Office LAN Network with Active Directory & Splunk Server (Part 1)

**Author:** Josiah Wu

---

---

## About

In this project, I have constructed a mini Office LAN network using VMWare virtual machines, including:

- Active Directory Domain Controller
- Splunk Server
- Kali Linux

Below is a diagram of our network topology.  
![Network-Topology](./images/Splunk-Project-Diagram.png)

The main steps used for this project are:

1.  Set up the virtual machines; Splunk Server on Ubuntu, Kali Linux, Window 10 hosts and Windows 2022 server.
2.  Install Splunk Universal Forwarder on the host machines and on the Windows 2022 server.
3.  Install Active Directory on Windows 2022 Server, create a domain, then and allow host to join the domain.
4.  Simulate a brute-force attack from Kali Linux machine to hosts, and check whether Splunk Server has detected the attack.
5.  Simulate different attacks in the hosts using the Atomic Red Team tool, then check whether Splunk Server has recorded them.

---

## Step 1 - Setting up the Virtual Machines

The below table shows our setup for each virtual machine.

| Device          | IP Address        | Operating System (iso) | Storage | Memory |
| --------------- | ----------------- | ---------------------- | ------- | ------ |
| `Splunk_Server` | `192.168.174.10`  | Linux Debian           | 30 GB   | 4 GB   |
| `ADDC_Server`   | `192.168.174.7`   | Microsoft Server 2022  | 60 GB   | 2 GB   |
| `Mgmt-PC`       | `192.168.174.129` | Windows 10             | 60 GB   | 4 GB   |
| `IT-PC`         | `192.168.174.161` | Windows 10             | 60 GB   | 4 GB   |
| `Kali Linux`    | `192.168.174.250` | Linux Debian           | 80 GB   | 4 GB   |

The virtual machines are run through VMWare Workstation. Our virtual network, `SO-LAN`, has the address `192.168.174.0/24`, and all the machines are placed into the same virtual network as the VMWare NAT adapter (with address `192.168.174.2`). This acts as our default gateway to the Internet.

`Mgmt-PC` and `IT-PC` are our host machines, used by the Management Department and IT Department of a Small Office company respectively.

`Splunk_Server`, as its name suggests, is a server that hosts Splunk - a Security Information and Event Management (SIEM) platform that organises and analyses data generated by our hosts. It is especially useful in detecting attacks on the host machines, which will be demonstrated later in this project.

`ADDC_Server` is the Domain Controller of our domain i.e. it acts as the central management device for the Active Directory services of our domain. In this project, we will perform authorization by restricting login access on the host computers.

`Kali Linux` is an open-source Linux distribution designed for penetration testing and digital forensics. It will be used to conduct attacks on the host machines using Atomic Red Team.

### Splunk_Server

After installation, we first want to configure a static IP for the splunk server. We achieved this by using `sudo netplan apply` on a manual configuration.

![Netplan-Config](./images/splunk-server-10.png)

![Apply-Netplan](./images/splunk-server-11.png)

We set our network configuration to have the static IP of 192.168.174.10, default gateway of `192.168.174.2` (NAT adapter) and DNS nameservers to Google `8.8.8.8`.

After successful pinging for connectivity, we can now install Splunk. We first installed Splunk Enterprise Debian version onto our local device, then create a shared folder in which we mount onto the `Splunk_Server` VM. The command to mount a shared folder in VMWare is `sudo vmhgfs-fuse`.

![Mount-Splunk](./images/splunk-server-01.png)

We can then see that Splunk has been successfully mounted onto the VM storage. We can find our Splunk folder through `cd ./opt/splunk`.

![Splunk Folder](./images/splunk-server-04.png)

Once the Splunk file has been successfully mounted, we can now try to activate Splunk. Since from the output of `ls -al` we see that the owner of the folder is `splunk`, we first must become the user `splunk`. This is achieved by the command `sudo -u splunk bash`.

![Activated-Splunk](./images/splunk-server-05.png)

Finally, we will redirect to the `bin` directory of splunk and start Splunk.

![Activated-Splunk](./images/splunk-server-08.png)

The Splunk Server is now activated on the network; any device on the network can now connect to Splunk through the address `192.168.174.10:8000`.

### ADDC_Server

## Step 2 - Installing Splunk Universal Forwarder

Splunk Universal Forwarder

### Resolution

To resolve the error with my security token, I attached the EC2 instance with an IAM role containing the IAM policy authorizing access to CodeArtifact. This resolved the error because now the instance has authority to do so.

It's a security best practice to use IAM roles because when applications are running on the instance, we can automatically use these temporary credentials to make AWS API calls without having to handle credential management.

---

## Step 3 - Install Active Directory on Windows 2022 Server and create a domain

The JSON policy I set up, for all resources:

- allows getting an authorization token for CodeArtifact.
- allows retrieving the endpoint for a CodeArtifact repository
- allows reading packages from a CodeArtifact repository.
- allows calling the GetServiceBearerToken action from the AWS Security Token Service (STS)

---

## Step 4 - Simulate a brute-force dictionary attack

### To test the connection between Maven and CodeArtifact, I compiled my web app using settings.xml

The settings.xml file configures Maven to add lists of servers, profiles and mirrors needed to set up the connection with CodeArtifact. Together, the code snippets define repository URLs, authentication details, and other settings so that Maven knows how to connect with CodeArtifact to fetch and store your project's dependencies.

Compiling means translating your project's code into a language that computers can understand and run.

---

## Step 5 - Simulate different attacks

After compiling, I checked my `nextwork-devops-cicd` repo. I noticed that all the packages I need are neatly stored in CodeArtifatct.

---

## Uploading My Own Packages

- Create your own custom package
- Publish it directly to your CodeArtifact repository
- Experience the full package lifecycle by downloading your own package
- Showcase advanced package management skills in your documentation!

To create my own package, I converted a text file into a tar.gz file. I also generated a security hash because it is required to verify its integrity.

To publish the package, I used the AWS CLI command `aws codeartifact publish-package-version`. When I look at the package details in CodeArtifact, I can see the new package being installed.

To validate my packages, I then decompressed the tar.gz file using the command `tar -xzvf secret-mission.tar.gz`. I then saw my original secret message!

![Image](http://learn.nextwork.org/motivated_indigo_zealous_griffin/uploads/aws-devops-codeartifact-updated_sm12-upload)

---

---
