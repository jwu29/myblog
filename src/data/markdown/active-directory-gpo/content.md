# Small Office LAN Network Simulation with Active Directory (Part 2: Group Policy Objects and File Sharing)

## Introduction

This is the continuation from the Part 1 of the Small Office LAN Project. In this project, I have constructed a mini Office LAN network using VMWare virtual machines, including:

- Active Directory Domain Controller
- Splunk Server

Whilst the focus of Part 1 is to configure message logging to Splunk Server, Part 2 will focus more on implementing Group Policy Objects (GPO) and shared resources inside the virtual network.

Below is a diagram of our network topology.  
![Network-Topology](./images/AD-Project-Part2-Diagram.png)

The main steps used for this project are:

1.  Set up the virtual machines; Splunk Server on Ubuntu, Kali Linux, Window 10 hosts and Windows 2022 server.
2.  Install Splunk Universal Forwarder on the host machines and on the Windows 2022 server.
3.  Install Active Directory on Windows 2022 Server, create a domain, then and allow host to join the domain.
4.  Implement Group Policy Objcets (GPO) to permit network discovery and file sharing for devices within the domain.
5.  Share resources using a shared folder within the domain.

---

## Step 1 - Setting up the Virtual Machines

The below table shows our setup for each virtual machine.

| Device          | IP Address        | Operating System (iso) | Storage | Memory |
| --------------- | ----------------- | ---------------------- | ------- | ------ |
| `Splunk_Server` | `192.168.174.10`  | Linux Debian           | 30 GB   | 4 GB   |
| `ADDC_Server`   | `192.168.174.7`   | Microsoft Server 2022  | 60 GB   | 2 GB   |
| `Mgmt-PC`       | `192.168.174.129` | Windows 10             | 60 GB   | 4 GB   |
| `IT-PC`         | `192.168.174.161` | Windows 10             | 60 GB   | 4 GB   |
| `Finance-PC`    | `192.168.174.193` | Windows 10             | 60 GB   | 4 GB   |
| `HR-PC`         | `192.168.174.225` | Windows 10             | 60 GB   | 4 GB   |

As in the previous part, the virtual machines are run through VMWare Workstation. Our virtual network, `SO-LAN`, has the address `192.168.174.0/24`, and all the machines are placed into the same virtual network as the VMWare NAT adapter (with address `192.168.174.2`). This acts as our default gateway to the Internet.

`Mgmt-PC`, `IT-PC`, `Finance-PC`, `HR-PC` are our host machines, used by the four departments of a Small Office company respectively.

`Splunk_Server`, as its name suggests, is a server that hosts Splunk - a Security Information and Event Management (SIEM) platform that organises and analyses data generated by our hosts. For this project, it is used to receive logs sent from the host machines.

`ADDC_Server` is the Domain Controller of our domain i.e. it acts as the central management device for the Active Directory services of our domain. In this project, we will perform authorization by restricting login access on the host computers.

### Splunk_Server

After installation, we first want to configure a static IP for the splunk server. We achieved this by using `sudo netplan apply` on a manual configuration.

![Netplan-Config](./images/splunk-server-10.png)

![Apply-Netplan](./images/splunk-server-11.png)

We set our network configuration to have the static IP of 192.168.174.10, default gateway of `192.168.174.2` (NAT adapter) and DNS nameservers to Google `8.8.8.8`.

After successful pinging for connectivity, we can now install Splunk. We first installed Splunk Enterprise Debian version onto our local device, then create a shared folder in which we mount onto the `Splunk_Server` VM. The command to mount a shared folder in VMWare is `sudo vmhgfs-fuse`.

![Mount-Splunk](./images/splunk-server-01.png)

We can then see that Splunk has been successfully mounted onto the VM storage. We can find our Splunk folder through `cd ./opt/splunk`.

![Splunk Folder](./images/splunk-server-04.png)

Once the Splunk file has been successfully mounted, we can now try to activate Splunk. Since from the output of `ls -al` we see that the owner of the folder is `splunk`, we first must become the user `splunk`. This is achieved by the command `sudo -u splunk bash`.

![Activated-Splunk](./images/splunk-server-05.png)

Finally, we will redirect to the `bin` directory of splunk and start Splunk.

![Activated-Splunk](./images/splunk-server-08.png)

The Splunk Server is now activated on the network; any device on the network can now connect to Splunk through the address `192.168.174.10:8000`.

## Step 2 - Installing Splunk Universal Forwarder

We now need to install Splunk Universal Forwarder and Sysmon in both `ADDC_Server` and the host machines. Sysmon is a Windows SysInternals tool that provides detailed logging of system activities; Splunk Universal Forwarder is responsible for delivering them to the Splunk server.

We first configure `ADDC_Server`, `Mgmt-PC` and `IT-PC` with their corresponding IPv4 addresses.

![ADDC-IP-settings](./images/addc-server-ip-config.png)  
_Configure IPv4 address on ADDC_Server_

We can then verify the IP configuration through the command `ipconfig all` on Command Prompt. Next, we will change the PC name on each device.

![ADDC-ipconfig](./images/addc-server-ipconfig.png)

After configuration, the device would be able to connect to the Splunk instance, as it is now a host inside our virtual network.

Moreover, we install the Splunk Universal Forwarder from the Splunk website on each VM.

![Splunk-Univ-Forwarder](./images/splunk-universal-forwarder.png)  
![Splunk-Univ-Forwarder2](./images/splunk-universal-forwarder-02.png)  
![Splunk-Univ-Forwarder3](./images/splunk-universal-forwarder-04.png)

Also, we install Sysmon from [Microsoft Learn](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon). In addition, the installation will be carried out according to the config file `sysmonconfig.xml`, which specifies what events to log or ignore. This configuration file is provided in the courtesy of `olafhartong` on [GitHub](https://github.com/olafhartong/sysmon-modular).

![Sysmon-Page](./images/sysmon-page.png)

![Sysmon-Config](./images/sysmon-config-page.png)

![Sysmon-Download](./images/mgmt-pc-sysmon-download.png)

We then control what Splunk Forwarder sends to its server by customizing `inputs.conf` in the folder `C:\Program Files\SplunkUniversal Forwarder`. Below is the configuration for `inputs.conf`, which declares what Windows Event Logs to collect and forward to Splunk Server.

```
[WinEventLog://Application]
index = endpoint
disabled = false

[WinEventLog://Security]
index = endpoint
disabled = false

[WinEventLog://System]
index = endpoint
disabled = false

[WinEventLog://Microsoft-Windows-Sysmon/Operational]
index = endpoint
disabled = false
renderXml = true
source = XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
```

![Service-Restart](./images/mgmt-pc-services.png)

However, this configuration would not be applied until we restart the Splunk Forwarder on `services.msc` through running as administrator. I also changed the "Log On" permissions to local to allow for authorised log collection.

Finally, we can open Splunk on our browser and log in; we then create an index named "endpoint", which corresponds to the index name in the above `inputs.conf` file. We then configure port 9997 as the receiving port.

![Splunk-Login-Page](./images/mgmt-pc-splunk-login.png)

![Splunk-Index-Tab](./images/mgmt-pc-splunk-settings.png)

![Splunk-Add-Index](./images/mgmt-pc-splunk-add-new-index.png)

![Splunk-Add-Listening-Port](./images/mgmt-pc-splunk-add-listening-port.png)

![Splunk-Listening-Port-Settings](./images/mgmt-pc-splunk-receive-port-settings.png)

![Splunk-Forward-Receive](./images/mgmt-pc-splunk-receive-port.png)

Finally, when we filter for `index="endpoint"` in our search, we will find a long list of logs generated from our hosts and Active Directory server.

![Splunk-Endpoint-Search](./images/mgmt-pc-splunk-index-endpoint-search.png)

---

## Step 3 - Install Active Directory on Windows 2022 Server and create a domain

On `ADDC_Server`, we open the Server Manager, then click on Manage > Next > Role-based > Add Active Directory Domain services. This will create our domain.

![ADDC-Add-AD-Services](./images/addc-server-add-roles-and-features.png)

We then name our domain `SO-LAN`, and promote `ADDC_Server` as the Domain Controller. We then add the domain to a new forest with the root domain name of `SO-LAN.local`.

![ADDC-Add-DC](./images/addc-server-new-forest.png)

![ADDC-Add-DC-Summary](./images/addc-server-new-forest-summary.png)

After configuring the password, leave everything as it is, then click Install. The computer will be restarted. The login screen shows `SO-LAN\Administrator`, which means `ADDC-Server` has been succesfully registered into the domain!

![ADDC-New-Login](./images/addc-server-new-login.png)

Let's log back into the Server Manager console, and create our users for the host machines `Mgmt-PC` and `IT-PC`. We would like to do this because we can configure access control by preventing cross-department access. (e.g. an user from IT cannot log in to Management PCs).

Here is a table of the users of this network. (The names in the below table are fictional and do not reflect real persons' or organisations' names).

| Name       | Username | Department | PC Access |
| ---------- | -------- | ---------- | --------- |
| Eva Woods  | `ewoods` | Management | `Mgmt-PC` |
| John Smith | `jsmith` | IT         | `IT-PC`   |

We first create an Organizational Unit (OU) for each department.

![ADDC-OU-List](./images/addc-server-domain-ou-list.png)

Then create users in each department's OU.

![ADDC-Management-OU](./images/ADDC-Management-Users.png)  
_List of users in Management Department_

![ADDC-IT-OU](./images/ADDC-IT-Users.png)  
_List of users in Management Department_

P.S. we should check the password requirements when creating our passwords. This can be found on `rsop.msc` > Computer Configuration > Policies > Windows Settings > Security Settings > Password Policy

![ADDC-Password-Policy-Brief](./images/addc-server-password-policy-brief.png)

![ADDC-Password-Policy-Detailed](./images/addc-server-password-policy-detailed.png)

After configuring passwords for each user, we then restrict each user to only access PCs of their respective departments.

![SOLAN-Restrict-Mgmt](./images/solan-restrict-mgmt-pc-login.png)

![SOLAN-Restrict-IT](./images/solan-restrict-it-pc-login.png)

Finally, we make each host machine join the newly created `SO-LAN` domain. In particular, we need to change the preferred DNS server to the Domain Controller `192.168.174.7`, as this will allow the host machines to contact the Domain Controller.

![Mgmt-DNS-Config](./images/mgmt-pc-dns-config.png)

Search PC > Properties > Advanced System Settings > Computer Name > "To rename this computer or change it domain or workgroup..."

![Mgmt-Join-Domain](./images/mgmt-pc-join-domain-page2.png)

![Mgmt-Join-Success](./images/mgmt-pc-join-domain-success.png)

After restarting the computer, we see that we can only login through a user.

![Mgmt-New-Login](./images/mgmt-pc-new-login.png)

We can try to log in with user credentials of the wrong department; the login is unsuccessful. In fact, one can only login by typing the credentials of a user in the matching department.

![Login-Blocked](./images/Login-Blocked.png)

Only when we type the correct credentials, we can log back in.

![Mgmt-User-Login](./images/mgmt-pc-ewoods-login.png)

---

## Step 4 - Permit network discovery and file sharing using GPOs

In this part, we will create a new Group Policy Object (GPO) to allow network discovery. To do this, we need to open Server Manager > Group Policy Management; this leads to a new window. Then in the left panel, go to Forest > Domains > `SO-LAN.local` > Group Policy Objects. We can then create a new GPO named "Allow Network Discovery".

![ADDC-New-GPO](./images/ADDC-New-GPO.png)

In our GPO, we would like to add rules for inbound traffic to allow file sharing and network discovery. This can be done on Computer Configuration > Policies > Windows Settings > Security Settings > Windows Firewall with Advanced Security > Inbound Rules.

![ADDC-Inbound-Rules-config](./images/ADDC-Inbound-Rules-config.png)

We can then add our desired rules, such as Network Discovery and File & Printer Sharing.

![ADDC-File-Sharing-Allow](./images/ADDC-File-Sharing-Allow.png)

![ADDC-File-Sharing-Predefined-Rules](./images/ADDC-File-Sharing-Predefined-Rules.png)

![ADDC-Inbound-Rules-Final](./images/ADDC-Inbound-Rules-Final.png)

Afterwards, go to Computer Configuration > Preferences > Control Panel Settings > Services to add the required services.

- FDResPub
- SSDPSRV
- upnphost

![ADDC-Services-FDResPub](./images/ADDC-Services-FDResPub.png)

![ADDC-Services-FDResPub-Config](./images/ADDC-Services-FDResPub-Config.png)

Here is our final configuration.

![ADDC-Services-Final](./images/ADDC-Services-Final.png)

Finally, we need to apply our newly created GPO onto each of our departmental OUs.

![ADDC-Apply-GPO](./images/ADDC-Apply-GPO.png)

Once that's done, we need to update the user policy through the command `gpupdate /force`. This will force update the user policies on each host machine.

Now we can create a shared folder for sharing resources in our domain.

---

## Step 5 - Share resources via a shared folder

Why would we want to create a shared resource folder in the first place? In Part 1, we have set up Splunk Universal Forwarder and Sysmon for every host PC. This is not a problem when there are only a few of them, but this becomes problematic when the number of hosts increases.

Therefore, a shared folder is necessary to fasten up the setting up process, hence increasing scalability of the network.

For each PC, go to This PC > Local Disk C: and create new folder called `SharedData`.

We then need to head to Server Manager > File and Storage Services > Shares to create a new share on SMB.

![SharedData-New-Share](./images/SharedData-New-Share.png)

We then go to its Properties > Security > Edit... to change folder access permissions. Here, we choose all users of `SO-LAN` to access folder contents.

![SharedData-Folder-Permissions](./images/SharedData-folder-permissions.png)

![SharedData-Folder-Permissions2](./images/SharedData-folder-permissions2.png)

We can see that `SharedData` is accessible in any PC that has joined the domain.

![SharedData-ADDC-Server](./images/SharedData-ADDC-SERVER.png)

Now we can put Splunk Universal Forwarder and Sysmon into the `SharedData` folder.

![Shared-Data-Access](./images/Shared-Data-Access.png)

Voila! Any PC which just joined the domain can just download from the folder, without having to download from the Internet again!

## Conclusion

In this project, we built a small-office LAN network that contains the following features:

- **Resource Sharing** was achieved through creating a new GPO that allows network discovery and file sharing for domain users only.
- **Scalability** was achieved by the creation of Organizational Units (OUs) and enforcing Group Policy Objects (GPOs) standardising user policies on these OUs.
- **Access Control** was implemented via Active Directory, restricting users to their department-specific workstations.

This setup utilises Active Directory for centralised management of a LAN network, highlighting its significance in modern office and business networks today.

---
